<!DOCTYPE html>
<html>
<!DOCTYPE html>
<html>

<head>
    <title>Mapbox GL JS debug page</title>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel='stylesheet' href='../dist/mapbox-gl.css'/>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.1/mapbox-gl-draw.css'
          type='text/css'/>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        html,
        body,
        #map {
            height: 100%;
        }

        .map-overlay {
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            position: absolute;
            width: 200px;
            top: 0;
            left: 0;
            padding: 10px;
        }

        .map-overlay .map-overlay-inner {
            background-color: #fff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            border-radius: 3px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .map-overlay-inner fieldset {
            border: none;
            padding: 0;
            margin: 0 0 10px;
        }

        .map-overlay-inner fieldset:last-child {
            margin: 0;
        }

        .map-overlay-inner select,
        .map-overlay-inner input {
            width: 100%;
        }

        .map-overlay-inner label {
            display: block;
            font-weight: bold;
            margin: 0 0 5px;
        }

        .debug label {
            display: inline;
            font-weight: normal;
        }

        .debug input {
            width: auto;
        }
    </style>
</head>

<body>

<div id='map'></div>
<div class="map-overlay top">
    <details open>
        <summary>Toggle controls</summary>
        <div class="map-overlay-inner">
            <fieldset>
                <label>Select base layer</label>
                <select id="layer" name="layer">
                    <option value="arcgis_satellite">arcgis 卫星</option>
                    <option value="bing_satellite" selected>必应卫星</option>
                    <option value="amap_satellite">高德卫星</option>
                    <option value="bmap_satellite">百度卫星</option>
                    <option value="google_satellite">谷歌卫星</option>
                    <option value="tmap_satellite">腾讯卫星</option>
                </select>
            </fieldset>
            <fieldset>
                <label>Select road layer</label>
                <select id="road" name="road">
                    <option value="">无</option>
                    <option value="tian_road">天地图路网</option>
                    <option value="amap_road" selected>高德路网</option>
                    <option value="bmap_street_view">百度街景覆盖</option>
                </select>
            </fieldset>
            <fieldset>
                <label>Select terrain</label>
                <select id="terrain" name="terrain">
                    <option value="" selected>无</option>
                    <option value="xinzhi-dem">新知</option>
                    <option value="mapbox-dem">mapbox</option>
                </select>
            </fieldset>
            <fieldset id="exaggeratedTerrain-div">
                <label>exaggeratedTerrain</label>
                <input
                    id="exaggeratedTerrain"
                    type="range"
                    min="0"
                    max="10"
                    step="0.1"
                    value="1"
                />
            </fieldset>
            <fieldset>
                <label>Select projection</label>
                <select id="projection" name="projection">
                    <option value="equalEarth">Equal Earth</option>
                    <option value="equirectangular">Equirectangular</option>
                    <option value="mercator" selected>Mercator</option>
                    <option value="globe">Globe</option>
                    <option value="naturalEarth">Natural Earth</option>
                    <option value="winkelTripel">Winkel Tripel</option>
                </select>
            </fieldset>
            <fieldset>
                <label>Show Debug </label>
                <div class="debug" id="debug">
                    <label>showTileBoundaries <input id="showTileBoundaries" type="checkbox"></label>
                    <label>showTerrainWireframe <input id="showTerrainWireframe" type="checkbox"></label>
                    <label>showPadding <input id="showPadding" type="checkbox"></label>
                    <label>showCollisionBoxes <input id="showCollisionBoxes" type="checkbox"></label>
                    <label>showOverdraw <input id="showOverdraw" type="checkbox"></label>
                    <label>showDebugTileLoadTime<input id="showDebugTileLoadTime" type="checkbox"></label>
                </div>
            </fieldset>
        </div>
    </details>
</div>

<script src='../dist/mapbox-gl-dev.js'></script>
<script src='../debug/access_token_generated.js'></script>
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.1/mapbox-gl-draw.js'></script>
<script src='./analysis/tin.js'></script>
<script src='./analysis/Delatin.js'></script>


<script>

    function getTXDy(data, x, y, z) {
        y = y || data.y;
        z = z || data.z;
        return Math.pow(2, z) - 1 - y;
    }

    function getTXX16(data, x, y, z) {
        x = x || data.x;
        return Math.floor(x / 16);
    }

    function getTXY16(data, x, y, z) {
        y = y || data.y;
        z = z || data.z;
        const dy = Math.pow(2, z) - 1 - y;
        return Math.floor(dy / 16);
    }

    const map = new mapboxgl.Map({
        container: 'map',
        renderWorldCopies: false,
        language: 'zh_CN',
        respectPrefersReducedMotion: false,
        style: {
            version: 8,
            light: {
                "anchor": "viewport",
                "color": "white",
                "intensity": 0.4
            },
            fog: {
                'horizon-blend': 0.3,
                'color': '#f8f0e3',
                'high-color': '#add8e6',
                'space-color': '#d8f2ff',
                'star-intensity': 0.0
            },
            // terrain: {
            //     source: 'mapbox-dem',
            //     exaggeration: 1
            // },
            sources: {
                'mapbox-dem': {
                    type: 'raster-dem',
                    tileSize: 512,
                    maxzoom: 14,
                    minzoom: 5,
                    tiles: ['https://api.mapbox.com/raster/v1/mapbox.mapbox-terrain-dem-v1/{z}/{x}/{y}.webp?access_token=pk.eyJ1IjoiYWRzMjkzNDk3MDc3OSIsImEiOiJjbDZuZnp6angwMGkwM2pzM2tueXN1NGl0In0.0l_OvoBv3UqIuDuWmbW-sw'],
                },
                'xinzhi-dem': {
                    type: 'raster-dem',
                    tileSize: 512,
                    maxzoom: 10,
                    minzoom: 5,
                    tiles: ['https://map.xinzhi.space/terrain/srtmv4/{z}/{x}/{y}.png'],
                    bounds: [71.25, 18, 135.5, 54]
                },
                'arcgis_satellite': {
                    type: 'raster',
                    tileSize: 128,
                    tiles: ['https://webst01.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}'],
                    projection: 'GCJ02'
                },
                'bing_satellite': {
                    type: 'raster',
                    tileSize: 256,
                    tiles: ['https://t.ssl.ak.tiles.virtualearth.net/tiles/a{quadkey}.jpeg?g=12946&n=z&prx=1']
                },
                'amap_satellite': {
                    type: 'raster',
                    tileSize: 128,
                    maxzoom: 18,
                    tiles: ['https://webst01.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}'],
                    projection: 'GCJ02'
                },
                'tian_road': {
                    type: 'raster',
                    tileSize: 128,
                    maxzoom: 18,
                    tiles: ['https://t0.tianditu.gov.cn/cia_w/wmts?service=WMTS&version=1.0.0&request=GetTile&tilematrix={z}&layer=cia&style=default&tilerow={y}&tilecol={x}&tilematrixset=w&format=tiles&tk=e67b6383a8f8d5826792cdb19f302c71']
                },
                'amap_road': {
                    type: 'raster',
                    tileSize: 256,
                    maxzoom: 18,
                    projection: 'GCJ02',
                    tiles: ['https://webst01.is.autonavi.com/appmaptile?style=8&x={x}&y={y}&z={z}']
                },
                'bmap_satellite': {
                    type: 'raster',
                    tileSize: 128,
                    maxzoom: 18,
                    projection: 'BAIDU',
                    // showDebugTileLoadTime: true,
                    tiles: [0, 1, 2, 3].map(s => `https://gss${s}.bdstatic.com/5bwHcj7lABFT8t_jkk_Z1zRvfdw6buu/it/u=x={x};y={y};z={z};v=009;type=sate&fm=46`),//['https://gss{s}.bdstatic.com/5bwHcj7lABFT8t_jkk_Z1zRvfdw6buu/it/u=x={x};y={y};z={z};v=009;type=sate&fm=46', 'https://mapsv1.bdimg.com/tile/?udt=20200825&qt=tile&styles=pl&x={x}&y={y}&z={z}'
                },
                'google_satellite': {
                    type: 'raster',
                    tileSize: 256,
                    projection: 'GCJ02',
                    maxzoom: 21,
                    tiles: ['https://www.google.com/maps/vt?lyrs=s&gl=cn&x={x}&y={y}&z={z}&scale=2']
                },
                'tmap_satellite': {
                    type: 'raster',
                    tileSize: 128,
                    projection: 'GCJ02',
                    scheme: 'tms',
                    maxzoom: 18,
                    tiles: [1, 2, 3].map(s => `https://p${s}.map.gtimg.com/sateTiles/{z}/{x16}/{y16}/{x}_{y}.jpg`),
                    customTags: {
                        dy: getTXDy,
                        x16: getTXX16,
                        y16: getTXY16
                    }
                },
                'bmap_street_view': {
                    type: 'raster',
                    tileSize: 128,
                    projection: 'BAIDU',
                    maxzoom: 18,
                    tiles: [0, 1].map(s => `https://mapsv${s}.bdimg.com/tile/?udt=20230629&qt=tile&styles=pl&x={x}&y={y}&z={z}`)
                },
                'image': {
                    type: "image",
                    url: "./333.png",
                    coordinates: [
                        [-180, 85],
                        [179.8, 85],
                        [179.8, -65],
                        [-180, -65]
                    ]
                }
                // 'tian_vt': {
                //     type: 'vector'
                // }
            },
            layers: [{
                id: "background", type: "background", "layout": {}, paint: {
                    "background-color": "hsl(0,0%,30%)"
                }, zIndex: -10
            }, {
                id: 'arcgis_satellite', type: 'raster', source: 'arcgis_satellite',
                layout: {
                    visibility: 'none'
                }
            }, {
                id: 'bing_satellite', type: 'raster', source: 'bing_satellite',
                layout: {
                    visibility: 'visible'
                }
            }, {
                id: 'amap_satellite', type: 'raster', source: 'amap_satellite',
                layout: {
                    visibility: 'none'
                }
            }, {
                id: 'bmap_satellite', type: 'raster', source: 'bmap_satellite',
                layout: {
                    visibility: 'none'
                }
            }, {
                id: 'google_satellite',
                type: 'raster',
                source: 'google_satellite',
                layout: {
                    visibility: 'none'
                }
            }, {
                id: 'tmap_satellite', type: 'raster', source: 'tmap_satellite',
                layout: {
                    visibility: 'none'
                }
            }, {
                id: 'tian_road', type: 'raster', source: 'tian_road',
                layout: {
                    visibility: 'none'
                }
            }, {
                id: 'amap_road', type: 'raster', source: 'amap_road',
                layout: {
                    visibility: 'visible'
                }
            }, {
                id: 'bmap_street_view', type: 'raster', source: 'bmap_street_view',
                layout: {
                    visibility: 'none'
                }
            }, {
                id: 'image', type: "raster", source: "image",
                paint: {
                    'raster-opacity': 0
                }
            }]
        },
        projection: 'mercator',
        zoom: 17,
        center: [106.494548, 29.580586],
        pitch: 0
    });

    const layerInput = document.getElementById('layer');
    const roadInput = document.getElementById('road');
    const terrain = document.getElementById('terrain');
    const exaggeratedTerrainInput = document.getElementById('exaggeratedTerrain');
    const projectionInput = document.getElementById('projection');
    const debugDiv = document.getElementById('debug');
    const exaggeratedTerrainDiv = document.getElementById('exaggeratedTerrain-div');
    exaggeratedTerrainDiv.style.display = 'none';

    let lastLayer = 'bing_satellite', lastRoad = 'amap_road';

    layerInput.addEventListener('change', () => {
        lastLayer && map.setLayoutProperty(lastLayer, 'visibility', 'none');
        layerInput.value && map.setLayoutProperty(layerInput.value, 'visibility', 'visible');
        lastLayer = layerInput.value;
    });

    roadInput.addEventListener('change', () => {
        lastRoad && map.setLayoutProperty(lastRoad, 'visibility', 'none');
        roadInput.value && map.setLayoutProperty(roadInput.value, 'visibility', 'visible');
        lastRoad = roadInput.value;
    });

    terrain.addEventListener('change', () => {
        if (terrain.value) {
            exaggeratedTerrainDiv.style.display = '';
            map.setTerrain({
                source: terrain.value,
                exaggeration: Number(exaggeratedTerrainInput.value)
            });
        } else {
            map.setTerrain(undefined);
            exaggeratedTerrainDiv.style.display = 'none';
        }
    });

    exaggeratedTerrainInput.addEventListener('change', () => {
        const terrain = map.getTerrain();
        if (terrain) {
            terrain.exaggeration = Number(exaggeratedTerrainInput.value);
            map.setTerrain(terrain);
        }
    });

    projectionInput.addEventListener('change', (e) => {
        map.setProjection(e.target.value);
    });

    debugDiv.addEventListener('click', (e) => {
        if (e.target instanceof HTMLInputElement) {
            map[e.target.id] = e.target.checked;
        }
    });

    const geojson = [];
    const data = {
        type: 'FeatureCollection',
        features: geojson
    };

    map.on('load', () => {
        map.addSource('geojson', {
            type: 'geojson',
            data: data
        });
        map.addLayer({
            id: 'geojson',
            type: 'line',
            source: 'geojson',
            paint: {
                'line-color': '#ff0000'
            }
        });
        map.addLayer({
            id: 'tin-vertex',
            type: 'circle',
            source: 'geojson',
            paint: {
                'circle-radius': 5,
                'circle-color': '#ffa654'
            }
        });
        /*const draw = new MapboxDraw();

        map.addControl(draw, 'top-right');
        map.on('draw.selectionchange', (e) => {
            const feature = e.features[0]
            if (!feature) return;
            // console.log(e)
            // generateTinFromPolygon(feature.geometry.coordinates[0], result => {
            //     console.log(result)
            //     const {highestAltitude, minimumAltitude, triangulation} = result;
            //     triangulation.forEach(t => {
            //         const c = t.slice(0, Infinity);
            //         c.push(c[0])
            //         geojson.push({
            //             "type": "Feature",
            //             "geometry": {
            //                 "type": "LineString",
            //                 "coordinates": c
            //             },
            //         })
            //     });
            //     map.getSource('geojson').setData(data);
            //     const n = calculate(triangulation, (highestAltitude + minimumAltitude) / 2);
            //     console.log(n)
            // });

            // calculate(tin, 200)

        });*/
        map.getSource('tian_road').on('error', (e) => {
            console.log(e);
            // e.target.setTiles(['https://t0.tianditu.gov.cn/cia_w/wmts?service=WMTS&version=1.0.0&request=GetTile&tilematrix={z}&layer=cia&style=default&tilerow={y}&tilecol={x}&tilematrixset=w&format=tiles&tk=e67b6383a8f8d5826792cdb19f302c71'])
        });
        console.log(map);

        // function getStreetBriefByLocation() {
        //     // http://apisv0.bdimg.com/?qt=qsdata&x=11857323.466123164&y=3433626.2685959353&r=50&action=1&auth_key=1688006760-1688004960000-HwOIc6QgPXmI6uBjZVGOlTGZwrnfG7X3-595920211df458015b1313531e2a4411&&fn=jsonp57929&sign=5f6d0b96eb84
        //     const url = 'http://mapsv1.bdimg.com/?udt=20200825&qt=qsdata&x=11857323.466123164&y=3433626.2685959353&r=50&actiom=1'
        //     const xhr = new XMLHttpRequest();
        //     xhr.open('get', url);
        //     xhr.onload = () => {
        //         console.log(xhr.response)
        //     }
        //     xhr.send()
        // }
        //
        // getStreetBriefByLocation()

        // console.time('tileSize-512')
        // map.transform.coveringTiles({tileSize: 512})
        // console.timeEnd('tileSize-512')
        // console.time('tileSize-256')
        // map.transform.coveringTiles({tileSize: 256})
        // console.timeEnd('tileSize-256')
        // console.time('tileSize-128')
        // map.transform.coveringTiles({tileSize: 128})
        // console.timeEnd('tileSize-128')

    });

</script>

</body>

</html>
